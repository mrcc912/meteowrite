var mongoose  = require('mongoose');

mongoose.connection.on('open', function (ref) {
    console.log('Connected to mongo server.');
});

mongoose.connection.on('error', function (err) {
    console.log('Could not connect to mongo server!');
    console.log(err);
});

mongoose.connect("mongodb://localhost/raw"); 
//mongoose.connect("mongodb://ec2-50-19-21-233.compute-1.amazonaws.com/panacheDB");
var db = mongoose.connection;

var ArticleSchema = mongoose.Schema({
    id: Number,
    headline: String,
    biline: String,
    creditline: String,
    source: String,
    section: String,
    URL: String,
    body: String,
    keywords: [Number]
});

var Article = mongoose.model("Article", ArticleSchema);

exports.addArticle = function(ID, head, bi, credit, src, sec, url, bod, func)
{
    Article.findOne( { id : ID}, function(err, article){
	if(article)
	{}
	else
	{
	    // read through article
	    var keys = [];
	    var words = bod.split(" ");
	    for(var i=0; i<words.length; i++)
	    {
		if(keys[words[i]])
		{
		    // if already in keywords
		    keys[words[i]]++;
		}
		else
		{
		    var weight= 1;
		    if(i <100)
			weight = 2;
		    keys[words[i]] = weight;
		}
	    }
	    console.log(keys);
	    // create article
	    var newArticle = new Article({
		id : ID,
		headline: head,
		biline: bi,
		creditline: credit,
		source: src,
		section: sec,
		URL: url,
		body: bod,
		keywords: keys
	    });
	    console.log(newArticle);
	    newArticle.save(function(err, doc){
		if(err) console.log(err);
		console.log(doc);
		func(doc);
	    });
	}
    });
};