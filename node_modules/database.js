var mongoose  = require('mongoose');
var alchemy = require('alchamy');

mongoose.connection.on('open', function (ref) {
    console.log('Connected to mongo server.');
});

mongoose.connection.on('error', function (err) {
    console.log('Could not connect to mongo server!');
    console.log(err);
});

mongoose.connect("mongodb://ec2-54-235-227-153.compute-1.amazonaws.com/raw");
//mongoose.connect("mongodb://ec2-50-19-21-233.compute-1.amazonaws.com/raw");
var db = mongoose.connection;
var Schema = mongoose.Schema;

var ArticleSchema = mongoose.Schema({
    id: Number,
    headline: String,
    biline: String,
    creditline: String,
    source: String,
    section: String,
    URL: String,
    body: String,
    keywords: Schema.Types.Mixed,
    reader: [Number]
});

var UserSchema = mongoose.Schema({
    username: String,
    fullname: String,
    hometown: String,
    current_location: String,
    gender: String,
    languages: [String],
    work: [String],
    articlesRead: [Number],
    tweetsRead: [Number],
    keywords: Schema.Types.Mixed,
    interests: Schema.Types.Mixed,

});

var User = mongoose.model("User", UserSchema);
var Article = mongoose.model("Article", ArticleSchema);

exports.addUser = function(name, fname, home, curr, gen, lang, work)
{
    User.findOne( {username: name}, function(err, user){
	if(user)
	{

	}
	else
	{
	    //create user
	    var object = new Object();
	    object["meteowrite-secret-num"] = 1.0;
	    var newUser = new User({
		username: name,
		fullname: fname,
		hometown: home,
		current_location: curr,
		gender: gen,
		languages: lang,
		work: work,
                articlesRead: new Array(),
		keywords: object
	    });
	    newUser.save(function(err,doc){
		if(err) throw err;
		console.log(doc);
	    });
	}
    });
};

exports.getArticles = function(func) {
  Article.find(function(err,articles) {
    if(err) throw err;
    func(articles);
  });
};

exports.getUsers = function(func) {
  User.find(function(err,users) {
    if(err) throw err;
    func(users);
  });

};

exports.getUser = function(userid, func)
{
    User.findOne( {username: userid}, function(err, user){
	if(err) throw err;
	func(user);
    });
};

exports.getArticle = function(articleid, func) {
  console.log(articleid);
  
  Article.findOne({id: articleid}, function(err, article){
    if(err) throw err;
    func(article); 	
  });
};

exports.addKeywords = function(userID, articleID, keys)
{
    //console.log(keys.keywords);
    User.findOne( {username: userID}, function(err, user){
	if(err) throw err;
	if(user)
	{
	    for(var i=0; i<keys.length; i++)
	    {
		var key = keys[i].text;
		if(keys[i].text.indexOf('.') != -1)
		    continue;
		if(user.keywords[keys[i].text])
		{
		    user.keywords[keys[i].text] += keys[i].relevance;
		}
		else
		{
		    user.keywords[keys[i].text] = keys[i].relevance;
		}
	    }
	    console.log(user.keywords);
            user.articlesRead.push(articleID);
            
            saveUser(user);
	}
    });
};

exports.addTweet = function(userID, tweetID, keys)
{
    User.findOne( {username: userID}, function(err, user){
	if(err) throw err;
	if(user)
	{
	    for(var i=0; i<keys.length; i++)
	    {
		var key = keys[i].text;
		if(keys[i].text.indexOf('.') != -1)
		    continue;
		if(user.keywords[keys[i].text])
		{
		    user.keywords[keys[i].text] += keys[i].relevance;
		}
		else
		{
		    user.keywords[keys[i].text] = keys[i].relevance;
		}
	    }
	    console.log(user.keywords);
	    if(!user.tweersRead) user.tweetsRead = new Array();
            user.tweetsRead.push(articleID);
            
            saveUser(user);
	}
    });
    
};

exports.userReadArticle = function(userID, articleID, dispFunc)
{
    User.findOne({username: userID}, function(err, user){
	if(err) throw err;
	if(user)
	{
            var intArtId = parseInt(articleID);
            
            var bool = 0;
            console.log(user.articlesRead);
            console.log(user.username);
            for(var i = 0; i < user.articlesRead.length; i = i + 1) {
              if(user.articlesRead[i] == articleID) {
                bool = 1;
              }
            }
            if(bool == 0) {
	    Article.findOne({id: intArtId}, function(err, article){
		for(var i = 0; i<article.keywords.length; i++) 
		{
                    var textMap = article.keywords[i];
                    var word = textMap["text"];
		    if(word.indexOf(".") != -1) 
                      continue;
                    var relev = textMap["relevance"];
                    if(word in user.keywords) {
		      user.keywords[word] += relev;
                    }
                    else {
                      user.keywords[word] = relev;
                    }
		}
                user.articlesRead.push(articleID);
                saveUser(user);
                dispFunc(user);
	    });
            }
            else {
              console.log("already read");  
              dispFunc(user);
            }
	}
    });
};

exports.articleOverlap = function(func) {
  console.log("BLA");
  var articles = Article.find(function(err,articles) {
    if(err) throw err;
    var smoke = new Object();
    for(var i = 0; i < articles.length; i++) {
      var articleId = articles[i].id;
      for(var j = 0; j < articles[i].keywords.length; j++) {
        var curMap = articles[i].keywords[j];
        var curText = curMap["text"];
        if(curText in smoke) {
          smoke[curText].push(articleId);
        }
        else {
          smoke[curText] = new Array();
          smoke[curText].push(articleId);
        }
      }
    }
    func(smoke);
  });
};

exports.addArticle = function(ID, head, bi, credit, src, sec, url, bod, func)
{
    Article.findOne( { id : ID}, function(err, article){
	if(article)
	{
	    
	}
	else
	{
	    // read through article

	    // create article
	    var newArticle = new Article({
		id : ID,
		headline: head,
		biline: bi,
		creditline: credit,
		source: src,
		section: sec,
		URL: url,
		body: bod,
	    });
	    newArticle.save(function(err, doc){
		if(err) console.log(err);
		console.log(doc);
		//populate with keywords
		
		func(doc);
	    });
	    console.log(newArticle);
	    
	}
    });
};



exports.populateKeywords = function(ID, keywords)
{
    Article.findOne( {id: ID} , function(err, article){
	if(err) throw err;
	if(article)
	{
	    article.keywords = keywords;
	    article.save(function(err, doc){
		if(err) throw err;
		if(doc)
		{
		    //huzzah
		}
	    });
	}
    });
};


function saveUser(user) {
  var newusername= user.username;
  var newfullname= user.fullname;
  var newhometown= user.hometown;
  var newcurrent_location= user.current_location;
  var newgender= user.gender;
  var newlanguages= user.languages;
  var newwork= user.work;
  var newarticles = user.articlesRead;
  var newkeywords= user.keywords;
  var newUser = new User({
    username: newusername,
    fullname: newfullname,
    hometown: newhometown,
    current_location: newcurrent_location,
    gender: newgender,
    languages: newlanguages,
    work: newwork,
    articlesRead: newarticles,
    keywords: newkeywords
 });

 user.remove();
 newUser.save(function(err, doc){
   if(err) throw err;
 });

}

exports.getArticlesRelatedToFacebook = function(username, token,  func)
{
    //get user likes from facebook
    var fql = require('fql');
    var https = require("https");

/*
    var token = "AAAGOBCs6uf8BAPWidZBW99Ng8blGxQRALd44jliYYljU3mcZBNLg5IjB2V2LnIKOCtZCuZAMbrUo8HSl1AT5eZCWlgCJZB4Yk1fo6DYlzVLgZDZD"; */
    var recs = [];
    fql({token: token}).query('SELECT uid FROM user WHERE username = "' + username+'"', function(err, data) {
	if (err) {
            throw err;
	}
	var id = data[0].uid;
	console.log(id);
	var mrcc = 505371215;
	

	var buffer = '';
	
	var path = "https://graph.facebook.com/" + id +"?fields=id,name,interests,likes&access_token=" + token; 
	https.get(path,
		  function(result){
		      console.log("huzzah");
		      
		      result.on('data', function(chunk){
			  buffer += chunk;
		      });
		      
		      result.on('end', function(){
			  console.log(buffer);
			  var obj = JSON.parse(buffer);
			  var likes = obj.likes.data;
			  var likeArr = [];
			  for(num in likes)
			  {
			      likeArr.push(likes[num].name);
			  }
			  console.log(likeArr);
			  Article.find({}).exec(function(err, articles){
			      if(err) throw err;
			      if(articles)
			      {
				  for(num in articles)
				  {
				      var words = JSON.parse(articles[num].keywords);
				      for(num in words)
				      {
					  if( likeArr.indexOf(words[num].text) >= 0)
					  {
					      var newRec = {};
					      newRec.url = articles[num].URL;
					      newRec.keyword = words[num].text;
					      newRec.relevance = words[num].relevance;
					      
					      recs.push(newRec);   
					  }
				      }
				  }
			      }
			      func(recs);
			  });
			  
		      });
		      
		  });
    });
};



exports.addWordsToUserBlacklist = function(username, goodWords, func) {
  User.findOne({username: username}, function(err, user) {
    if(err) throw err;
    if(user) {
      var wordsToDelete = new Array();
      for(var key1 in user.keywords) {
        if(goodWords.indexOf(key1) == -1) {
          wordsToDelete.push(key1);
        }
      }
      for(var i = 0; i < wordsToDelete.length; i++) {
        delete user.keywords[wordsToDelete[i]];
      }
      saveUser(user);
      func(user); 
    } 
  });
};


exports.relatedArticlesForUserObj = function(user, numRec, func)
{
            var articleScores = new Object();
            var articleObject = new Object();
            Article.find(function(err,articles) {
              if(err) throw err;
              console.log(articles.length);
              for(var i = 0; i < articles.length; i++) {
                var art = articles[i];
                articleObject[art.headline] = new Object();
                if(user.articlesRead.indexOf(art.id) == -1) {
                  articleScores[art.headline] = 0;

                  for(var j = 0; j < art.keywords.length; j++) {
                    var keyMap = art.keywords[j];
                    var word = keyMap["text"];
                    var relev = keyMap["relevance"];
                    var userWord = 0;
                    if(word in user.keywords) {
                      console.log(word);
                      userWord = user.keywords[word];
                      articleObject[art.headline][word] = userWord*relev;
                    }
                      articleScores[art.headline] = articleScores[art.headline] + userWord * relev;
                  }
                }
              }

              var artArr = new Array();
              for (var key in articleScores) {
                artArr.push([key, articleScores[key], articleObject[key]]);
              }

              for(var i = 0; i < artArr.length; i++) {
                for(var j = i; j < artArr.length; j++) {
                  if(artArr[i][1] < artArr[j][1]) {
                    var tmp = artArr[j];
                    artArr[j] = artArr[i];
                    artArr[i] = tmp;
                  }
                }
              }
              var retArr = new Object();
              var bla = numRec;
              if(bla > artArr.length) {
                bla = artArr.length;
              }
              for(var i = 0; i < bla; i++) {
                retArr[artArr[i][0]] = artArr[i][2];
              }

              func(retArr);
          });
};



exports.relatedArticlesForUser = function(username, numRec, func)
{
    User.findOne({username: username}, function(err, user){
	if(err) throw err;
	if(user)
	{
            var articleScores = new Object();
            var articleObject = new Object(); 
	    Article.find(function(err,articles) {
              if(err) throw err;
              console.log(articles.length);
              for(var i = 0; i < articles.length; i++) {
                var art = articles[i];
                articleObject[art.headline] = new Object();
                if(user.articlesRead.indexOf(art.id) == -1) {
                  articleScores[art.headline] = 0;
                 
                  for(var j = 0; j < art.keywords.length; j++) {
                    var keyMap = art.keywords[j];
                    var word = keyMap["text"];
                    var relev = keyMap["relevance"];
                    var userWord = 0;
                    if(word in user.keywords) {
                      console.log(word);
                      userWord = user.keywords[word];
                      articleObject[art.headline][word] = userWord*relev;
                    }
                      articleScores[art.headline] = articleScores[art.headline] + userWord * relev;
                  }
                }
              }
            
              var artArr = new Array();
              for (var key in articleScores) {
                artArr.push([key, articleScores[key], articleObject[key]]);
              }

              for(var i = 0; i < artArr.length; i++) {
                for(var j = i; j < artArr.length; j++) {
                  if(artArr[i][1] < artArr[j][1]) {
                    var tmp = artArr[j];
                    artArr[j] = artArr[i];
   		    artArr[i] = tmp;
                  }
                }
              } 
              var retArr = new Object();
              var bla = numRec;
              if(bla > artArr.length) {
                bla = artArr.length;
              }
              for(var i = 0; i < bla; i++) {
                retArr[artArr[i][0]] = artArr[i][2];
              }

              func(retArr);
          });
        }
    });
};


exports.getTopKeywordsForArticle = function(articleID, num, func)
{
    console.log(articleID);
    Article.findOne({id: articleID}, function(err, article){
	if(err)
	{
	    throw err;
	}
	if(article)
	{
	    var sorted = articles.keywords.slice(0).sort(function(a, b){ 
		return a.value - b.value });
	    console.log(sorted);
	    func(sorted);
	}
    });
    
    /*
    var keywords = {};
    keywords['tree'] = 0.57467;
    keywords['fly-fishing'] = 0.87632;
    keywords['dogs'] = 0.3245;
    keywords['fishing'] = 0.7654;
    func(JSON.stringify(keywords);
    */
}

exports.getArticleReaderInterests = function(articleID, func)
{
    Article.findOne({id: articleID}, function(err, article){
	if(err)
	    throw err;
	if(article)
	{
	    var interests = [];
	    for(var i=0; i<article.readers.length; i++)
	    {
		User.findOne({id: article.readers[i]}, function(err, reader){
		    if(err) throw err;
		    if(reader)
		    {
			for(var j=0; j<reader.keywords.length; j++)
			{
			    if(interests[reader.keywords[j].text] != null)
				interests[reader.keywords[j].text] += reader.keywords[j].relevance;
			    else
				interests[reader.keywords[j].text] = reader.keywords[j].relevance;
			}
			interests.sort();
			func(interests);
		    }
			
		});
	    }
	}
    });
}